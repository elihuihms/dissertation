#!/usr/bin/perl

#
# Generates a single target file from any number of conformer files present in <spec_file>, each with the specified weighting
#

if( $#ARGV == -1 )
{
	print "Usage: make_target.pl <spec_file>\n";
	exit;
}

@components = ();
@distances = ();
@target_x = ();
@target_y = ();

#
# Experimental errors are expressed as percentage of y
# Assuming 256 points evenly sampling q from 0.0 to 0.32
#
# Experimental uncertainty values obtained from als_02272011, pure Bsu. TRAP sample
#

# 10mg/mL error
#@target_dy = (1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.00628529675897,0.00325748091848761,0.00231362917359263,0.00786713418830632,0.00398877183203263,0.00263987965436388,0.00255956403290389,0.0023525953463951,0.00235831606984893,0.00257616585933696,0.0019338723802327,0.00183642771346066,0.00203430529560417,0.00208521010561092,0.00181718539869878,0.00222106038131362,0.00177279279585842,0.0017539398645479,0.0019505394159297,0.00222635653627044,0.00202168427342962,0.00191930602350008,0.00221908647124217,0.00219682661159844,0.00214684265377095,0.0020273745981822,0.00229942521923605,0.00218134433981895,0.00230363904882507,0.00239539878091319,0.00226393256556434,0.00235168599106597,0.0023551233999675,0.00213033968129599,0.0023888114340391,0.00260414127497926,0.00254311482564961,0.00268237201411924,0.00257385539662937,0.00286738612701816,0.00284361992810678,0.00283132076951125,0.00286819716960405,0.00293714202495763,0.00288689297838367,0.00311611126018834,0.00292013875902975,0.00305917941750993,0.00323883171026373,0.00295284030023385,0.00329040022948814,0.00355335573608658,0.00333389130145421,0.00333905728594944,0.00407731581082888,0.00362336093404812,0.0034035442010779,0.00345280485354668,0.00343079141437294,0.0037327851642317,0.00388159434513723,0.00393625193749126,0.00395756633419543,0.00425302348874049,0.00431640538128385,0.00424210152155143,0.00427410575240701,0.00437937697763711,0.00461549991964836,0.00449477575369053,0.00515967551054168,0.00575692292860928,0.00586398647563848,0.00583715532782041,0.00580764253487865,0.00581884546044571,0.00599467887269095,0.00587076062849391,0.00585585886894438,0.00643788005145819,0.00658019304419538,0.00630775336529292,0.00671483058461816,0.00710106676192418,0.00677107161492828,0.00718024571957633,0.00728762706777,0.00714052048879146,0.00778322762717815,0.00731649986985757,0.0078727228796065,0.00768791942379944,0.00836131419266435,0.00756632464373176,0.00842242787331833,0.00909595450865414,0.0087399075096723,0.00921189759833676,0.0100040353437537,0.0105330129403092,0.0100157288679242,0.0108238770113798,0.0115734475510572,0.0113705896244368,0.0118235479978987,0.012213469749221,0.0121268484972355,0.0124343294363145,0.0137847172217431,0.0149371595580651,0.0151604449052049,0.0154133904290579,0.0168884370395609,0.0171815494358269,0.0185532006586829,0.0176712453216875,0.019144760248688,0.0195582779760505,0.0207620987379877,0.0219645263351097,0.0240112883270237,0.0265910689097452,0.0267493195102281,0.0260503969470447,0.0299989900981834,0.0326777467860595,0.0341452645911633,0.0364823958256224,0.0384619400510719,0.0435395716370421,0.046577728026136,0.0548528738660001,0.0581419855404322,0.0613939028937983,0.0670739300479264,0.0596925154439724,0.0650109021801211,0.0642579801288539,0.0623366035012973,0.0718153357419351,0.0676842636263119,0.0695057778350852,0.0736642682068948,0.0819903003694889,0.074074947368592,0.0661946203284249,0.0617123574285895,0.0763135384861867,0.05931619121145,0.0589711425913812,0.0568237627808691,0.0603501073730313,0.0786360178951886,0.0705298998539017,0.0764197211245492,0.0965804004734209,0.0623447216610399,0.06136250073421,0.0595219252834144,0.0634231211928076,0.0589498340181581,0.0584143564241699,0.0572159958542422,0.0513187214912595,0.0558580604167697,0.0537958217141227,0.0529952082331849,0.0483340345350751,0.0517854983478518,0.0536766881347527,0.0558412344046153,0.0536899437282255,0.0513948501795719,0.051900512502677,0.0522888785235512,2.22349949408613,3.00942058037321,0.421937522139335,0.0587655837039573,0.0535787092718514,0.0493594619679918,0.0491233856528575,0.0479472239633805,0.0505496458381056,0.0485147600529317,0.052446332793,0.0519459701393615,0.0462454182279974,0.0468247858605487,0.0442069466059678,0.0444753455762013,0.0451715958119631,0.0498979616645813,0.0515933378601165,0.0432880749085323,0.0461784425621448,0.0467020859087257,0.0418779718683909,0.0398697210141143,0.0392500975170112,0.0409251243684794,0.0398443452231562,0.0405564911607496,0.0380444930373949,0.0355084383499677,0.0381014599296488,0.0359984121643999,0.0352272920244112,0.035391851168096,0.0340298261692484,0.0355923031377816,0.0374157185150208,0.0332874266067916,0.0304645341129607,0.0306283822162834,0.0310749172680687,0.0307678431057554,0.0289895816416737,0.0300339885731645,0.0292304661529507,0.0310343508125428,0.0302010186254868,0.0286374733637246,0.0295717234635803,0.0293449955376236,0.0299558340370086,0.0292638306303476,0.030185060190716,0.028938864737481,0.0291064671557648,0.0316990644864474,0.028584853974301,0.0287071738803712,0.0305765065566515,0.0315346738952003,0.0295721827432829,0.028534263398237,0.0304697027118066,0.0302418048672096,0.0306179036432382,0.0353533636837601,0.035349511220441,0.0416842627070321,0.0421899048016309,0.0442111027128388,0.0516575428530386,1.0);

# 5mg/mL error
#@target_dy = (1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.0275804986057,0.0204846866011684,0.0118651821265717,0.0108552494040678,0.00942097158256079,0.00750915345980148,0.0093289625706734,0.00709982944287521,0.00669658580259485,0.0035775543611417,0.0029132211405147,0.00281672536583332,0.0031212441758041,0.00287910203029539,0.00289237434310638,0.00299502802438349,0.00255308822271924,0.00286178708806369,0.00307207257793824,0.00264653417271312,0.00262535230099832,0.00259989057407923,0.00271897051153074,0.00266473385491437,0.00265588724039557,0.00257682912501566,0.00259389568551658,0.00261250371994352,0.00293338989444507,0.00299424012883303,0.00269591101138184,0.00303312542963956,0.00307365054239438,0.00306916576298778,0.00335370552457686,0.00340454349509617,0.003106541820459,0.00315977611752008,0.00343029039058428,0.00381577613342434,0.00335969997537582,0.00385908278113533,0.00364715305103977,0.00383533645384237,0.00383479330425574,0.00413687770663997,0.00411299244408489,0.00429591294029702,0.00440699382541777,0.00448557265736472,0.00493951279546748,0.00463169866780855,0.00473120237156157,0.00464452801807378,0.0048578874696196,0.00498966041823062,0.00530064704121408,0.00595058640989141,0.00574134583511166,0.00589338595454936,0.00630124771515872,0.00671440946863769,0.00698536090407814,0.00750744577140452,0.00730429495410188,0.00767737397749238,0.00785365913349011,0.00778232187307474,0.00892409674214807,0.00908134136040263,0.00989575998941501,0.00976001154073789,0.00974134202966251,0.0109317869061232,0.0106013932148989,0.0113040758911437,0.0107082291188811,0.0110702662169559,0.0117886296328812,0.0125147468882895,0.0126584712889817,0.0130001005302146,0.0141116543033947,0.0142581048489224,0.0135274280170941,0.0135942280815158,0.0142727301403579,0.01415744583275,0.0149539854625263,0.0158625326638757,0.0146193545067534,0.0155274426018393,0.0164759804489392,0.0164053939419464,0.017651156078402,0.0187187598878155,0.0194987027079378,0.0181774043211811,0.0186937595632893,0.0195562306301624,0.0202899223962377,0.0214674208490404,0.0225769422761224,0.0230055521414579,0.0227621851215888,0.0243199797366243,0.025452099919149,0.0270753529608158,0.0302061437544465,0.0288253413765592,0.0295239148995697,0.03103520033925,0.0339427274386875,0.0347911166425289,0.0386201113526069,0.0369863614908563,0.041622045968339,0.040755458353097,0.0424002606352005,0.0443998419589319,0.0491878426218586,0.0542290252135094,0.0564041109767808,0.0590370848761882,0.0604074599485433,0.0665842018589916,0.0656112226163855,0.0672227643506791,0.0814005753651009,0.0898221996829207,0.0868453854085758,0.109606584056859,0.115688381397459,0.117907334239059,0.125341069119277,0.118738581550405,0.142858923082579,0.157531868250102,0.145832653387598,0.144467731670349,0.141991757473579,0.120002859584289,0.127563837925368,0.188192585958286,0.16608083512992,0.146553694482316,0.142686119174257,0.132436474923576,0.12159135729025,0.101593200101693,0.105381173723822,0.123417398290691,0.129532676957262,0.141124459677527,0.124382019811342,0.116742676598766,0.121531818863785,0.132597641139809,0.125679175803382,0.111851695392852,0.126359101929079,0.136203991686779,0.128820894972619,0.109468239805628,0.119669020028605,0.109806342189648,0.110745677106658,0.097221609111425,0.0893474436475128,0.0950779512331466,0.112499506026243,0.117132650114707,0.101578015479937,0.0978337075181454,0.0920244066728064,0.0944121632178454,0.0944412824867752,0.102196002993104,0.116737190755949,0.118754924792513,0.109728570806951,0.0988090590703363,0.0910546200311393,0.102583248392378,0.101473964679617,0.100587915317548,0.0922829033096497,0.0917956152310581,0.085708999839133,0.0796664260245711,0.0934190354054817,0.098868454097421,0.11632685089528,0.101654760868647,0.0881257398521487,0.0766613885019729,0.0885170962031636,0.0816494236450731,0.0756395588911923,0.0802418563526673,0.0814526567740069,0.0774873160421094,0.0802645867635316,0.0799044388838114,0.0789781196702039,0.0761439307737349,0.0792716112687497,0.0784187167775522,0.0753380253791573,0.0697193355628919,0.0774170726972197,0.0751315478733715,0.0653080516589901,0.0653042022748488,0.0624392389063017,0.061383414713746,0.0685332817904847,0.0607374663646664,0.059716916801624,0.0591921804534052,0.0583533809382195,0.0608274218822132,0.0591205094374689,0.0586424868982272,0.0636382974597645,0.0635735141173735,0.059510929739795,0.0623781993786868,0.0576926088755541,0.0594322744797335,0.0667618033962404,0.0615468381082438,0.0610192892543764,0.0551714917671433,0.0602265140636902,0.0628382602730414,0.0574288591191095,0.0587269020226194,0.0601341228710906,0.0580075327052289,0.0656635806699344,0.0669293287140983,0.0790022753580077,0.0860081725506459,0.083107139312404,0.0958677647826464,1.0);

# 3mg/mL error
@target_dy = (1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.0119858370781,0.00742208929735171,0.00785871947628921,0.00987718110123138,0.00682895339466947,0.00604618771420825,0.00458381670049921,0.00414309600521059,0.00584753753202783,0.00380401120919406,0.0031710827283324,0.00317830449369321,0.00355977758452205,0.00275374421733474,0.0035318818933427,0.00453266620178454,0.0027075460236424,0.00305790924988737,0.00339156600662051,0.00325709342760625,0.0028880642126228,0.00320751699927817,0.00372246383813849,0.00374034615638719,0.00352566069109273,0.00317770279086875,0.00329019371196316,0.00348894386477316,0.00351558523856059,0.00321703040454115,0.00334081589621961,0.00375067049230383,0.00357076751739688,0.00353754312721872,0.00357008647905686,0.00385952590911914,0.00389647123453589,0.00439147968223095,0.00426019872139915,0.00477590290637566,0.00452301887184066,0.00453217132101217,0.00508781075041197,0.00538832884246079,0.00525113100622483,0.00574418398389016,0.00492920253058803,0.00573275680221605,0.00628341856408998,0.00597797895904742,0.00702829143865653,0.00622307291352743,0.0066300906726821,0.00703100821401549,0.00720898856302184,0.00652320105056437,0.00777869519188921,0.00844191459061084,0.00790593587951183,0.00852117181976053,0.00932747530917938,0.00949260445536527,0.00981031656310605,0.0110647628762258,0.01150732465869,0.0119097765704571,0.0118102373102158,0.0132034681484401,0.013415634310325,0.0128932318097421,0.0150195864397885,0.016273817076652,0.0155163950115596,0.0175523838290423,0.0170108133997218,0.0172901470274281,0.0171116857399781,0.0188894026375056,0.017524682993175,0.0188613509391324,0.0197036860537127,0.0187441364251542,0.0221596231202487,0.0220757880436253,0.0201896901669053,0.0216255192742737,0.0226172688671316,0.0212458908742559,0.0250427360560395,0.0251050380609941,0.0241179240657496,0.0242650501572115,0.0261823877446568,0.0235399175105516,0.0265399072392612,0.0293660673721426,0.0284651701332897,0.0304849149758196,0.0315608263358215,0.0308724290813184,0.0312338351499943,0.0340421442443488,0.0362080518974194,0.0365064366088684,0.0358022749279759,0.0613291395536825,0.0391177330928464,0.0373945981924118,0.04241841823225,0.0443847245997901,0.0453154243606513,0.0469455485838895,0.0524912076835049,0.0610194771767512,0.0632615481368955,0.0630299170608281,0.0718549249583493,0.0593800854936466,0.0635084223310497,0.0680874396923038,0.0849306561453951,0.0901143613542872,0.10378091726465,0.0827989794140052,0.0928722584483092,0.104190500902905,0.113510089414464,0.0961962270116528,0.132769416444707,0.152293619990758,0.149535765002455,0.137794645975668,0.19412057302316,0.199175862275931,0.286443969991098,0.211733335105558,0.355389679157159,0.245851051028684,0.267499866601432,0.325953999409895,0.445688851857709,0.251688404302763,0.278928535173987,0.70327321672236,0.401502730204656,0.251768430435424,0.201299703654789,0.310754970378021,0.292548473641998,0.160797762569806,0.177719509583388,0.224759371823174,0.261453719979893,0.55930559638223,0.37798900758509,0.210444939631197,0.331615816672769,0.23147010705091,0.179374656582171,0.207103686033237,0.307622856155658,0.212100475043545,0.204667846941395,0.15611966272799,0.224151012085829,0.192029628856816,0.169805547803723,0.173547933491,0.179398826652758,0.218314474018748,0.288803760037095,0.222622644196187,0.185458065650125,0.211885059695034,0.19868117511191,0.185429575844939,0.158577378464474,0.187480986541847,0.273236002438634,0.23077311352008,0.285415919604095,0.223838386978273,0.173861998612393,0.183784424836224,0.175523932737872,0.143788258162256,0.120338380243329,0.13240619669621,0.149257276727405,0.137262947726809,0.155510131040072,0.167549422237816,0.272732345369844,0.174725816602289,0.134163654819729,0.125962941311027,0.148603723131253,0.117264814195942,0.118348539170171,0.12698767342789,0.140950190844901,0.155463939480625,0.151054679085924,0.171429020762436,0.140244859247118,0.122622439998095,0.136117733894498,0.125871719502049,0.115389208982316,0.120758321680382,0.141207677893079,0.137716387697842,0.127145013888551,0.0987293908422504,0.0998145868500688,0.10743220258753,0.143042590299098,0.101982630106159,0.107004451217987,0.108615401789073,0.102756669139461,0.120389342744132,0.100989269924236,0.0968154022817448,0.105796577184357,0.119939088414495,0.103045321896378,0.103671021906323,0.107856562224597,0.114481240284013,0.120815289072467,0.0988791388916612,0.0863259097625366,0.105953188819745,0.109124445220826,0.10300450952935,0.0976956641737381,0.102017505569168,0.101790971216178,0.0936146530740128,0.118322589805551,0.115990016100224,0.1339853091379,0.122777276037138,0.113453427128591,0.138132675177875,1.0);

# consistent 2% error
#@target_dy = ();
#for($i=0; $i<1024; $i++){
#	push(@target_dy,0.02);
#}

open FILE, $ARGV[0] or die( "Could not open conformer file '$ARGV[0]': $!" );
while (<FILE>)
{
	$line = $_;
	if( $line =~ m/^(\S+)\s+(\S+)/ )
	{
		$file = $1;
		$weight = $2;
		
		open CONF, $file or die( "Bad conformer file '$file' specified in spec file: $!" );
		while(<CONF>){
			if( $_ =~ /^CURV/ )
			{
				$i = 0;
				while(<CONF>)
				{
					if( $_ =~ /^(\S+)\s+(\S+)/ )
					{
						$target_x[$i] = $1;
						$target_y[$i] = $target_y[$i] + ( $weight * $2 );
						$i++;
					}
				}
			}
			elsif( $_ =~ /^STCH/ )
			{
				@a = split( "\t", $_ );
				chomp( @a );

				for( $i=1; $i<=$#a; $i++ ){
					$components[ $i -1] += $a[ $i ] * $weight;
				}
			}
		}
	}
}

print "NAME\t<enter name here>\n\n";

print "STCH\t1";
for( $i=0; $i<=$#components; $i++){
	print "\t".$components[$i];
}
print "\n";

for( $i=0; $i<=$#target_x; $i++)
{
	$y	= $target_y[$i] + ($target_y[$i] * $target_dy[$i] * gaussian_rand());
	$dy	= $target_y[$i] * $target_dy[$i];
	
	print $target_x[$i]."\t".($y*1.0E6)."\t".($dy*1.0E6)."\n";
}

#
# From the Perl cookbook
# (http://docstore.mik.ua/orelly/perl/cookbook/ch02_11.htm)
#

sub gaussian_rand
{
    my ($u1, $u2);  # uniformly distributed random numbers
    my $w;          # variance, then a weight
    my ($g1, $g2);  # gaussian-distributed numbers

    do {
        $u1 = 2 * rand() - 1;
        $u2 = 2 * rand() - 1;
        $w = $u1*$u1 + $u2*$u2;
    } while ( $w >= 1 );

    $w = sqrt( (-2 * log($w))  / $w );
    $g2 = $u1 * $w;
    $g1 = $u2 * $w;
    # return both if wanted, else just one
    return wantarray ? ($g1, $g2) : $g1;
}